<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Driver Live Tracking</title>
  <link rel="stylesheet" th:href="@{/css/styles.css}">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
</head>
<body>
<div class="container">
  <h2>ðŸš‘ Driver Live Tracking</h2>
  <div id="map" style="height:400px; border-radius:8px;"></div>
  <p id="status">Waiting for patient location...</p>
</div>

<script th:inline="javascript">
  let map, driverMarker, patientMarker;
  let bookingId;
  bookingId = [[$,{bookingId}]];

  function initMap() {
    map = L.map('map').setView([7.8731, 80.7718], 8);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© OpenStreetMap'
    }).addTo(map);
  }

  function sendDriverLocation(lat, lng) {
    stomp.send("/app/driver/location", {}, JSON.stringify({
      bookingId: bookingId, latitude: lat, longitude: lng
    }));
  }

  const socket = new SockJS('/ws');
  const stomp = Stomp.over(socket);
  stomp.connect({}, () => {
    stomp.subscribe('/topic/patient-location/' + bookingId, (msg) => {
      const {lat, lng} = JSON.parse(msg.body);
      document.getElementById('status').innerText = "Patient location received";
      if (!map) initMap();
      if (!patientMarker)
        patientMarker = L.marker([lat, lng]).addTo(map).bindPopup("Patient");
      else
        patientMarker.setLatLng([lat, lng]);
    });
  });

  if (navigator.geolocation) {
    navigator.geolocation.watchPosition(pos => {
      let lat = pos.coords.latitude;
      let lng = pos.coords.longitude;
      if (!map) initMap();
      if (!driverMarker)
        driverMarker = L.marker([lat, lng]).addTo(map).bindPopup("You (Driver)");
      else
        driverMarker.setLatLng([lat, lng]);
      sendDriverLocation(lat, lng);
    });
  } else {
    document.getElementById('status').innerText = "Geolocation not supported.";
  }
</script>
</body>
</html>
